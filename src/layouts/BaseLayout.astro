---
import '../styles/global.css';
import RuleSidebar from '../components/RuleSidebar.astro';
import Header from '../components/Header.astro';

interface Props {
  title: string;
  description?: string;
  ruleset?: 'civil' | 'criminal' | 'appellate' | 'evidence' | 'bankruptcy';
  noSidebar?: boolean;
}

const {
  title,
  description = 'Federal Rules of Civil and Criminal Procedure — professional reference for attorneys and law students.',
  ruleset,
  noSidebar = false,
} = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <title>{title} — Federal Rules</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css" />
  </head>
  <body class="min-h-screen" style="background-color: #f8f5f0;">

    <!-- Skip to main content link (accessibility - WCAG 2.4.1) -->
    <a
      href="#main-content"
      id="skip-link"
      style="position: absolute; left: -9999px; top: auto; width: 1px; height: 1px; overflow: hidden; z-index: 100; font-family: system-ui, sans-serif; font-size: 0.875rem; font-weight: 500;"
    >
      Skip to main content
    </a>
    <style>
      #skip-link:focus {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        top: 1rem;
        width: auto;
        height: auto;
        overflow: visible;
        background-color: #1a2744;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        text-decoration: none;
      }
    </style>

    {!noSidebar && (
      <!-- Mobile sidebar toggle -->
      <button
        id="sidebar-toggle"
        aria-label="Open rule navigation"
        aria-expanded="false"
        aria-controls="rule-sidebar"
        class="fixed top-3 left-3 z-50 p-2 rounded shadow-md md:hidden"
        style="background-color: #1a2744; color: white;"
      >
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" aria-hidden="true">
          <path d="M2 4.5h14M2 9h14M2 13.5h14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </button>
    )}

    {!noSidebar && (
      <!-- Mobile overlay -->
      <div
        id="sidebar-overlay"
        class="fixed inset-0 z-30 hidden md:hidden"
        style="background-color: rgba(0,0,0,0.5);"
        aria-hidden="true"
      ></div>
    )}

    <div class="flex min-h-screen">
      {!noSidebar && (
        <!-- Left sidebar: fixed on mobile, sticky on desktop -->
        <aside
          id="rule-sidebar"
          class="fixed top-0 left-0 h-full w-[260px] z-40 overflow-y-auto
                 -translate-x-full transition-transform duration-200
                 md:sticky md:translate-x-0 md:top-0 md:h-screen md:shrink-0"
          style="background-color: #1a2744; color: white;"
          aria-label="Rule navigation"
        >
          {ruleset && <RuleSidebar ruleset={ruleset} />}
        </aside>
      )}

      <!-- Main content column -->
      <div class="flex-1 min-w-0 flex flex-col">
        <Header noSearch={noSidebar} />
        <main id="main-content" tabindex="-1">
          <slot />
        </main>
      </div>
    </div>

    <script>
      // Cross-reference auto-linking + side-by-side panel
      // Exits immediately on any page without a rule body.
      const ruleBody = document.querySelector<HTMLElement>('.rule-body');
      if (ruleBody) {
        const ruleset = window.location.pathname.split('/').filter(Boolean)[0] ?? '';
        const RULESETS: Record<string, string> = {
          civil: 'Civil Procedure',
          criminal: 'Criminal Procedure',
          appellate: 'Appellate Procedure',
          evidence: 'Evidence',
          bankruptcy: 'Bankruptcy Procedure',
        };
        if (RULESETS[ruleset]) {
          // ── 1. Inject the reference panel ────────────────────────────────
          const panel = document.createElement('aside');
          panel.id = 'rule-ref-panel';
          panel.setAttribute('aria-label', 'Referenced rule');
          panel.style.cssText =
            'position:fixed;right:0;top:0;height:100vh;width:min(46vw,640px);z-index:35;' +
            'background:#f8f5f0;border-left:1px solid rgba(28,28,30,0.15);' +
            'box-shadow:-4px 0 24px rgba(0,0,0,0.1);overflow-y:auto;display:none;';
          panel.innerHTML = `
            <div id="rp-header" style="position:sticky;top:0;z-index:1;
              background:rgba(248,245,240,0.95);backdrop-filter:blur(8px);
              border-bottom:1px solid rgba(28,28,30,0.1);
              padding:0.875rem 1.25rem;display:flex;align-items:flex-start;
              justify-content:space-between;gap:0.75rem;">
              <div style="min-width:0;">
                <p id="rp-ruleset" style="font-size:0.625rem;font-weight:700;letter-spacing:0.1em;
                  text-transform:uppercase;color:#6b7280;font-family:system-ui,sans-serif;
                  margin-bottom:0.2rem;"></p>
                <p id="rp-title" style="font-size:0.9375rem;font-weight:700;color:#1c1c1e;
                  font-family:'Lora',Georgia,serif;line-height:1.3;"></p>
              </div>
              <div style="display:flex;align-items:center;gap:0.5rem;flex-shrink:0;margin-top:0.1rem;">
                <a id="rp-link" href="" style="font-size:0.6875rem;font-family:system-ui,sans-serif;
                  color:#1a2744;font-weight:600;text-decoration:none;
                  border:1px solid rgba(26,39,68,0.3);padding:0.25rem 0.5rem;
                  border-radius:0.25rem;white-space:nowrap;transition:background 0.12s;">
                  Full rule ↗
                </a>
                <button id="rp-close" type="button" aria-label="Close reference panel"
                  style="font-size:1.125rem;color:#6b7280;background:none;border:none;
                  cursor:pointer;padding:0.125rem 0.25rem;line-height:1;transition:color 0.12s;">
                  ✕
                </button>
              </div>
            </div>
            <div id="rp-body" style="padding:1.25rem 1.5rem 3rem;"></div>
          `;
          document.body.appendChild(panel);

          const rpClose = document.getElementById('rp-close')!;
          const rpLink  = document.getElementById('rp-link') as HTMLAnchorElement;
          const rpTitle = document.getElementById('rp-title')!;
          const rpLabel = document.getElementById('rp-ruleset')!;
          const rpBody  = document.getElementById('rp-body')!;

          function closePanel() { panel.style.display = 'none'; }
          rpClose.addEventListener('click', closePanel);
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && panel.style.display !== 'none') closePanel();
          });

          // ── 2. Fetch referenced rule and populate panel ───────────────────
          async function openPanel(ruleNum: string) {
            const url = `/${ruleset}/${ruleNum}/`;
            rpLink.href = url;
            rpLabel.textContent = RULESETS[ruleset];
            rpTitle.textContent = `Rule ${ruleNum}`;
            rpBody.innerHTML =
              '<p style="color:#6b7280;font-family:system-ui,sans-serif;font-size:0.875rem;">Loading…</p>';
            panel.style.display = 'block';
            panel.scrollTop = 0;
            try {
              const res = await fetch(url);
              if (!res.ok) throw new Error(String(res.status));
              const html = await res.text();
              const doc = new DOMParser().parseFromString(html, 'text/html');
              const h1 = doc.querySelector('article h1');
              if (h1) rpTitle.textContent = h1.textContent ?? `Rule ${ruleNum}`;
              const body = doc.querySelector('.rule-body');
              rpBody.innerHTML = '';
              if (body) rpBody.appendChild(document.adoptNode(body));
              else rpBody.innerHTML =
                '<p style="color:#6b7280;font-family:system-ui,sans-serif;font-size:0.875rem;">Content not available.</p>';
            } catch {
              rpBody.innerHTML =
                '<p style="color:#6b7280;font-family:system-ui,sans-serif;font-size:0.875rem;">Could not load rule.</p>';
            }
          }

          // ── 3. Auto-link "Rule N" / "Rule N.N" in the rule body ──────────
          const RULE_RE = /\bRule\s+(\d+(?:\.\d+)?)\b/g;
          function linkify(node: Node) {
            if (node.nodeType === Node.TEXT_NODE) {
              const text = node.textContent ?? '';
              RULE_RE.lastIndex = 0;
              if (!RULE_RE.test(text)) return;
              const wrap = document.createElement('span');
              RULE_RE.lastIndex = 0;
              wrap.innerHTML = text.replace(RULE_RE, (match, num) =>
                `<a href="/${ruleset}/${num}/" class="rule-xref" data-rule="${num}"
                   style="color:inherit;border-bottom:1px dotted rgba(26,39,68,0.5);
                   text-decoration:none;cursor:pointer;">${match}</a>`
              );
              node.parentNode?.replaceChild(wrap, node);
            } else if (
              node.nodeType === Node.ELEMENT_NODE &&
              !(node as Element).matches('a, script, style, code, pre')
            ) {
              Array.from(node.childNodes).forEach(linkify);
            }
          }
          linkify(ruleBody);

          // Intercept clicks on cross-ref links (desktop only — mobile navigates normally)
          ruleBody.addEventListener('click', (e) => {
            if (window.innerWidth < 768) return;
            const link = (e.target as Element).closest<HTMLAnchorElement>('.rule-xref');
            if (!link) return;
            e.preventDefault();
            openPanel(link.dataset.rule!);
          });
        }
      }
    </script>

    {!noSidebar && (
      <script is:inline>
        const toggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('rule-sidebar');
        const overlay = document.getElementById('sidebar-overlay');

        function openSidebar() {
          sidebar.classList.remove('-translate-x-full');
          overlay.classList.remove('hidden');
          toggle.setAttribute('aria-label', 'Close rule navigation');
          toggle.setAttribute('aria-expanded', 'true');
          document.body.style.overflow = 'hidden';
          // Move focus into sidebar
          const firstLink = sidebar.querySelector('a, button, [tabindex="0"]');
          if (firstLink) firstLink.focus();
        }

        function closeSidebar() {
          sidebar.classList.add('-translate-x-full');
          overlay.classList.add('hidden');
          toggle.setAttribute('aria-label', 'Open rule navigation');
          toggle.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = '';
          // Return focus to toggle
          toggle.focus();
        }

        toggle.addEventListener('click', () => {
          toggle.getAttribute('aria-expanded') === 'true' ? closeSidebar() : openSidebar();
        });
        overlay.addEventListener('click', closeSidebar);

        // Auto-close sidebar when a rule link is tapped on mobile
        sidebar.querySelectorAll('a').forEach((link) => {
          link.addEventListener('click', () => {
            if (window.innerWidth < 768) closeSidebar();
          });
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') closeSidebar();

          // Focus trap: when sidebar is open, keep Tab within sidebar elements
          if (e.key === 'Tab' && toggle.getAttribute('aria-expanded') === 'true') {
            const focusable = Array.from(
              sidebar.querySelectorAll('a, button, [tabindex="0"], [tabindex="-1"]:not([tabindex="-1"])')
            ).filter((el) => !el.hasAttribute('disabled') && el.offsetParent !== null);
            if (focusable.length === 0) return;
            const first = focusable[0];
            const last = focusable[focusable.length - 1];
            if (e.shiftKey) {
              if (document.activeElement === first) {
                e.preventDefault();
                last.focus();
              }
            } else {
              if (document.activeElement === last) {
                e.preventDefault();
                first.focus();
              }
            }
          }
        });
      </script>
    )}
  </body>
</html>
