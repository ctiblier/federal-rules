---
import '../styles/global.css';
import RuleSidebar from '../components/RuleSidebar.astro';
import Header from '../components/Header.astro';

interface Props {
  title: string;
  description?: string;
  ruleset?: 'civil' | 'criminal';
  noSidebar?: boolean;
}

const {
  title,
  description = 'Federal Rules of Civil and Criminal Procedure — professional reference for attorneys and law students.',
  ruleset,
  noSidebar = false,
} = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <title>{title} — Federal Rules</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css" />
  </head>
  <body class="min-h-screen" style="background-color: #f8f5f0;">

    <!-- Skip to main content link (accessibility - WCAG 2.4.1) -->
    <a
      href="#main-content"
      id="skip-link"
      style="position: absolute; left: -9999px; top: auto; width: 1px; height: 1px; overflow: hidden; z-index: 100; font-family: system-ui, sans-serif; font-size: 0.875rem; font-weight: 500;"
    >
      Skip to main content
    </a>
    <style>
      #skip-link:focus {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        top: 1rem;
        width: auto;
        height: auto;
        overflow: visible;
        background-color: #1a2744;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        text-decoration: none;
      }
    </style>

    {!noSidebar && (
      <!-- Mobile sidebar toggle -->
      <button
        id="sidebar-toggle"
        aria-label="Open rule navigation"
        aria-expanded="false"
        aria-controls="rule-sidebar"
        class="fixed top-3 left-3 z-50 p-2 rounded shadow-md md:hidden"
        style="background-color: #1a2744; color: white;"
      >
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" aria-hidden="true">
          <path d="M2 4.5h14M2 9h14M2 13.5h14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </button>
    )}

    {!noSidebar && (
      <!-- Mobile overlay -->
      <div
        id="sidebar-overlay"
        class="fixed inset-0 z-30 hidden md:hidden"
        style="background-color: rgba(0,0,0,0.5);"
        aria-hidden="true"
      ></div>
    )}

    <div class="flex min-h-screen">
      {!noSidebar && (
        <!-- Left sidebar: fixed on mobile, sticky on desktop -->
        <aside
          id="rule-sidebar"
          class="fixed top-0 left-0 h-full w-[260px] z-40 overflow-y-auto
                 -translate-x-full transition-transform duration-200
                 md:sticky md:translate-x-0 md:top-0 md:h-screen md:shrink-0"
          style="background-color: #1a2744; color: white;"
          aria-label="Rule navigation"
        >
          {ruleset && <RuleSidebar ruleset={ruleset} />}
        </aside>
      )}

      <!-- Main content column -->
      <div class="flex-1 min-w-0 flex flex-col">
        <Header />
        <main id="main-content" tabindex="-1">
          <slot />
        </main>
      </div>
    </div>

    {!noSidebar && (
      <script is:inline>
        const toggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('rule-sidebar');
        const overlay = document.getElementById('sidebar-overlay');

        function openSidebar() {
          sidebar.classList.remove('-translate-x-full');
          overlay.classList.remove('hidden');
          toggle.setAttribute('aria-label', 'Close rule navigation');
          toggle.setAttribute('aria-expanded', 'true');
          document.body.style.overflow = 'hidden';
          // Move focus into sidebar
          const firstLink = sidebar.querySelector('a, button, [tabindex="0"]');
          if (firstLink) firstLink.focus();
        }

        function closeSidebar() {
          sidebar.classList.add('-translate-x-full');
          overlay.classList.add('hidden');
          toggle.setAttribute('aria-label', 'Open rule navigation');
          toggle.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = '';
          // Return focus to toggle
          toggle.focus();
        }

        toggle.addEventListener('click', () => {
          toggle.getAttribute('aria-expanded') === 'true' ? closeSidebar() : openSidebar();
        });
        overlay.addEventListener('click', closeSidebar);

        // Auto-close sidebar when a rule link is tapped on mobile
        sidebar.querySelectorAll('a').forEach((link) => {
          link.addEventListener('click', () => {
            if (window.innerWidth < 768) closeSidebar();
          });
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') closeSidebar();

          // Focus trap: when sidebar is open, keep Tab within sidebar elements
          if (e.key === 'Tab' && toggle.getAttribute('aria-expanded') === 'true') {
            const focusable = Array.from(
              sidebar.querySelectorAll('a, button, [tabindex="0"], [tabindex="-1"]:not([tabindex="-1"])')
            ).filter((el) => !el.hasAttribute('disabled') && el.offsetParent !== null);
            if (focusable.length === 0) return;
            const first = focusable[0];
            const last = focusable[focusable.length - 1];
            if (e.shiftKey) {
              if (document.activeElement === first) {
                e.preventDefault();
                last.focus();
              }
            } else {
              if (document.activeElement === last) {
                e.preventDefault();
                first.focus();
              }
            }
          }
        });
      </script>
    )}
  </body>
</html>
