---
import '../styles/global.css';
import RuleSidebar from '../components/RuleSidebar.astro';
import Header from '../components/Header.astro';

interface Props {
  title: string;
  description?: string;
  ruleset?: 'civil' | 'criminal' | 'appellate' | 'evidence' | 'bankruptcy';
  noSidebar?: boolean;
}

const {
  title,
  description = 'Federal Rules of Civil and Criminal Procedure — professional reference for attorneys and law students.',
  ruleset,
  noSidebar = false,
} = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <title>{title} — Federal Rules</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="stylesheet" href="/pagefind/pagefind-ui.css" />
  </head>
  <body class="min-h-screen" style="background-color: #f8f5f0;">

    <!-- Skip to main content link (accessibility - WCAG 2.4.1) -->
    <a
      href="#main-content"
      id="skip-link"
      style="position: absolute; left: -9999px; top: auto; width: 1px; height: 1px; overflow: hidden; z-index: 100; font-family: system-ui, sans-serif; font-size: 0.875rem; font-weight: 500;"
    >
      Skip to main content
    </a>
    <style>
      #skip-link:focus {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        top: 1rem;
        width: auto;
        height: auto;
        overflow: visible;
        background-color: #1a2744;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        text-decoration: none;
      }
      /* Cross-reference links — visually distinct, not disruptive */
      .rule-xref {
        color: #1a2744 !important;
        font-weight: 600 !important;
        text-decoration: underline !important;
        text-decoration-style: dotted !important;
        text-underline-offset: 3px !important;
        text-decoration-color: rgba(26,39,68,0.5) !important;
        cursor: pointer;
      }
      .rule-xref:hover, .rule-xref:focus {
        color: #8b5c08 !important;
        text-decoration-style: solid !important;
        text-decoration-color: #c9a84c !important;
        outline: none;
      }
      .rule-xref:focus-visible {
        outline: 2px solid #c9a84c;
        outline-offset: 2px;
        border-radius: 2px;
      }
      /* Hide Pagefind's built-in filter checkboxes site-wide (we use our own controls) */
      .pagefind-ui__filter-panel { display: none !important; }
      /* Search sticky: non-sticky on mobile so results scroll naturally */
      @media (max-width: 767px) {
        .search-sticky { position: static !important; top: auto !important; }
      }
      /* Back to top */
      #back-to-top {
        position: fixed;
        bottom: 1.5rem;
        right: 1.5rem;
        z-index: 40;
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        background: #1a2744;
        color: #c9a84c;
        border: none;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.25);
        transition: transform 0.15s;
      }
      #back-to-top:hover { transform: translateY(-2px); }
      #back-to-top:focus-visible { outline: 2px solid #c9a84c; outline-offset: 2px; }
    </style>

    {!noSidebar && (
      <!-- Mobile sidebar toggle -->
      <button
        id="sidebar-toggle"
        aria-label="Open rule navigation"
        aria-expanded="false"
        aria-controls="rule-sidebar"
        class="fixed top-3 left-3 z-50 p-2 rounded shadow-md md:hidden"
        style="background-color: #1a2744; color: white;"
      >
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" aria-hidden="true">
          <path d="M2 4.5h14M2 9h14M2 13.5h14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </button>
    )}

    {!noSidebar && (
      <!-- Mobile overlay -->
      <div
        id="sidebar-overlay"
        class="fixed inset-0 z-30 hidden md:hidden"
        style="background-color: rgba(0,0,0,0.5);"
        aria-hidden="true"
      ></div>
    )}

    <div class="flex min-h-screen">
      {!noSidebar && (
        <!-- Left sidebar: fixed on mobile, sticky on desktop -->
        <aside
          id="rule-sidebar"
          class="fixed top-0 left-0 h-full w-[260px] z-40 overflow-y-auto
                 -translate-x-full transition-transform duration-200
                 md:sticky md:translate-x-0 md:top-0 md:h-screen md:shrink-0"
          style="background-color: #1a2744; color: white;"
          aria-label="Rule navigation"
        >
          {ruleset && <RuleSidebar ruleset={ruleset} />}
        </aside>
      )}

      <!-- Main content column -->
      <div class="flex-1 min-w-0 flex flex-col">
        <Header noSearch={noSidebar} />
        <main id="main-content" tabindex="-1">
          <slot />
        </main>
      </div>
    </div>

    <!-- Back to top button -->
    <button
      id="back-to-top"
      type="button"
      aria-label="Back to top"
    >
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
        <path d="M8 13V3M3 8l5-5 5 5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <script>
      // ── Back to top ───────────────────────────────────────────────────────
      const btt = document.getElementById('back-to-top') as HTMLButtonElement | null;
      if (btt) {
        window.addEventListener('scroll', () => {
          btt.style.display = window.scrollY > 400 ? 'flex' : 'none';
        }, { passive: true });
        btt.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
      }

      // ── Ruleset filter indicator on ruleset index pages ───────────────────
      // Shows "Searching: Civil Procedure" above the search box so users know results are pre-filtered.
      const INDEX_LABELS: Record<string, string> = {
        civil: 'Civil Procedure',
        criminal: 'Criminal Procedure',
        appellate: 'Appellate Procedure',
        evidence: 'Evidence',
        bankruptcy: 'Bankruptcy Procedure',
      };
      const indexMatch = window.location.pathname.match(/^\/(civil|criminal|appellate|evidence|bankruptcy)\/?$/);
      if (indexMatch) {
        const rs = indexMatch[1];
        const searchSection = document.getElementById('search');
        if (searchSection && INDEX_LABELS[rs]) {
          const indicator = document.createElement('p');
          indicator.style.cssText =
            'font-size:0.75rem;font-family:system-ui,sans-serif;color:#1a2744;' +
            'font-weight:600;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.375rem;';
          indicator.innerHTML =
            `<span style="display:inline-block;width:0.5rem;height:0.5rem;border-radius:50%;background:#1a2744;flex-shrink:0;" aria-hidden="true"></span>` +
            `Searching: ${INDEX_LABELS[rs]}`;
          searchSection.insertAdjacentElement('afterbegin', indicator);
        }
      }

      // ── Cross-reference auto-linking + side-by-side panel ────────────────
      // Only runs on rule pages (pages with .rule-body). Exits early otherwise.
      const ruleBody = document.querySelector<HTMLElement>('.rule-body');
      if (ruleBody) {
        const ruleset = window.location.pathname.split('/').filter(Boolean)[0] ?? '';
        const RULESETS: Record<string, string> = {
          civil: 'Civil Procedure',
          criminal: 'Criminal Procedure',
          appellate: 'Appellate Procedure',
          evidence: 'Evidence',
          bankruptcy: 'Bankruptcy Procedure',
        };

        if (RULESETS[ruleset]) {
          // Screen-reader live region for panel state announcements
          const srAnnounce = document.createElement('div');
          srAnnounce.setAttribute('aria-live', 'polite');
          srAnnounce.setAttribute('aria-atomic', 'true');
          srAnnounce.style.cssText =
            'clip:rect(0,0,0,0);height:1px;overflow:hidden;position:absolute;width:1px;white-space:nowrap;';
          document.body.appendChild(srAnnounce);

          // ── Reference panel ─────────────────────────────────────────────
          const panel = document.createElement('aside');
          panel.id = 'rule-ref-panel';
          panel.setAttribute('role', 'region');
          panel.setAttribute('aria-label', 'Referenced rule');
          panel.setAttribute('tabindex', '-1');
          panel.style.cssText =
            'position:fixed;right:0;top:0;height:100vh;width:min(46vw,640px);z-index:35;' +
            'background:#f8f5f0;border-left:1px solid rgba(28,28,30,0.15);' +
            'box-shadow:-4px 0 24px rgba(0,0,0,0.1);overflow-y:auto;display:none;';
          panel.innerHTML = `
            <div id="rp-header" style="position:sticky;top:0;z-index:1;
              background:rgba(248,245,240,0.95);backdrop-filter:blur(8px);
              border-bottom:1px solid rgba(28,28,30,0.1);
              padding:0.875rem 1.25rem;display:flex;align-items:flex-start;
              justify-content:space-between;gap:0.75rem;">
              <div style="min-width:0;">
                <p id="rp-ruleset" style="font-size:0.625rem;font-weight:700;letter-spacing:0.1em;
                  text-transform:uppercase;color:#6b7280;font-family:system-ui,sans-serif;
                  margin-bottom:0.2rem;"></p>
                <p id="rp-title" style="font-size:0.9375rem;font-weight:700;color:#1c1c1e;
                  font-family:'Lora',Georgia,serif;line-height:1.3;"></p>
              </div>
              <div style="display:flex;align-items:center;gap:0.5rem;flex-shrink:0;margin-top:0.1rem;">
                <a id="rp-link" href=""
                  style="font-size:0.6875rem;font-family:system-ui,sans-serif;
                  color:#1a2744;font-weight:600;text-decoration:none;
                  border:1px solid rgba(26,39,68,0.3);padding:0.25rem 0.5rem;
                  border-radius:0.25rem;white-space:nowrap;transition:background 0.12s;"
                  aria-label="Open full rule page">
                  Full rule ↗
                </a>
                <button id="rp-close" type="button" aria-label="Close reference panel"
                  style="font-size:1.125rem;color:#6b7280;background:none;border:none;
                  cursor:pointer;padding:0.125rem 0.375rem;line-height:1;transition:color 0.12s;
                  border-radius:0.25rem;">✕</button>
              </div>
            </div>
            <div id="rp-body" style="padding:1.25rem 1.5rem 3rem;"></div>
          `;
          document.body.appendChild(panel);

          const rpClose = document.getElementById('rp-close') as HTMLButtonElement;
          const rpLink  = document.getElementById('rp-link') as HTMLAnchorElement;
          const rpTitle = document.getElementById('rp-title')!;
          const rpLabel = document.getElementById('rp-ruleset')!;
          const rpBody  = document.getElementById('rp-body')!;

          let panelTrigger: HTMLElement | null = null;

          function closePanel() {
            panel.style.display = 'none';
            panelTrigger?.focus(); // return focus to the link that opened the panel
            panelTrigger = null;
          }
          rpClose.addEventListener('click', closePanel);
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && panel.style.display !== 'none') closePanel();
          });

          // Convert subsection string "(a)(1)" → anchor "#a-1"
          function toAnchor(subs: string): string {
            const parts = [...subs.matchAll(/\(([^)]+)\)/g)].map(m => m[1]);
            return parts.length ? '#' + parts.join('-') : '';
          }

          // ── Fetch + display a referenced rule ──────────────────────────
          async function openPanel(ruleNum: string, anchor: string, trigger: HTMLElement) {
            panelTrigger = trigger;
            const url = `/${ruleset}/${ruleNum}/`;
            rpLink.href = url;
            rpLabel.textContent = RULESETS[ruleset] ?? '';
            rpTitle.textContent = `Rule ${ruleNum}`;
            rpBody.innerHTML =
              '<p style="color:#6b7280;font-family:system-ui,sans-serif;font-size:0.875rem;padding:0.5rem 0;">Loading…</p>';
            panel.style.display = 'block';
            panel.scrollTop = 0;
            requestAnimationFrame(() => rpClose.focus()); // move focus into panel
            srAnnounce.textContent = `Opening Rule ${ruleNum}`;

            try {
              const res = await fetch(url);
              if (!res.ok) throw new Error(String(res.status));
              const html = await res.text();
              const doc = new DOMParser().parseFromString(html, 'text/html');
              const h1 = doc.querySelector('article h1');
              if (h1) rpTitle.textContent = h1.textContent?.trim() ?? `Rule ${ruleNum}`;
              const body = doc.querySelector('.rule-body');
              rpBody.innerHTML = '';
              if (body) {
                // Prefix all IDs to avoid conflicts with main page element IDs
                body.querySelectorAll('[id]').forEach(el => { el.id = 'rp-' + el.id; });
                rpBody.appendChild(document.adoptNode(body));
                // Scroll to subsection if a specific anchor was requested
                if (anchor) {
                  const anchorId = 'rp-' + anchor.slice(1); // "#a-1" → "rp-a-1"
                  requestAnimationFrame(() => {
                    const target = rpBody.querySelector<HTMLElement>(`#${CSS.escape(anchorId)}`);
                    if (target) target.scrollIntoView({ block: 'start', behavior: 'smooth' });
                  });
                }
              } else {
                rpBody.innerHTML =
                  '<p style="color:#6b7280;font-family:system-ui,sans-serif;font-size:0.875rem;">Content not available.</p>';
              }
              srAnnounce.textContent = `Rule ${ruleNum} loaded`;
            } catch {
              rpBody.innerHTML =
                '<p style="color:#6b7280;font-family:system-ui,sans-serif;font-size:0.875rem;">Could not load rule. Try opening the full rule page.</p>';
              srAnnounce.textContent = `Could not load Rule ${ruleNum}`;
            }
          }

          // ── Auto-link "Rule N(a)(b)..." patterns in rule text ──────────
          // Captures optional subsection sequence: "Rule 26(a)(1)" → href="/civil/26/#a-1"
          const RULE_RE = /\bRule\s+(\d+(?:\.\d+)?)\s*((?:\([^)]+\))*)/g;

          function linkify(node: Node) {
            if (node.nodeType === Node.TEXT_NODE) {
              const text = node.textContent ?? '';
              RULE_RE.lastIndex = 0;
              if (!RULE_RE.test(text)) return;
              const wrap = document.createElement('span');
              RULE_RE.lastIndex = 0;
              wrap.innerHTML = text.replace(RULE_RE, (match, num, subs) => {
                const anchor = toAnchor(subs ?? '');
                const href = `/${ruleset}/${num}/${anchor}`;
                return `<a href="${href}" class="rule-xref" data-rule="${num}" data-anchor="${anchor}"` +
                  ` aria-label="${match}: view in side panel">${match}</a>`;
              });
              node.parentNode?.replaceChild(wrap, node);
            } else if (
              node.nodeType === Node.ELEMENT_NODE &&
              !(node as Element).matches('a, script, style, code, pre')
            ) {
              Array.from(node.childNodes).forEach(linkify);
            }
          }
          linkify(ruleBody);

          // On desktop: open side panel. On mobile: follow the href normally.
          ruleBody.addEventListener('click', (e) => {
            if (window.innerWidth < 768) return;
            const link = (e.target as Element).closest<HTMLAnchorElement>('.rule-xref');
            if (!link) return;
            e.preventDefault();
            openPanel(link.dataset.rule!, link.dataset.anchor ?? '', link);
          });
        }
      }
    </script>

    {!noSidebar && (
      <script is:inline>
        const toggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('rule-sidebar');
        const overlay = document.getElementById('sidebar-overlay');

        function openSidebar() {
          sidebar.classList.remove('-translate-x-full');
          overlay.classList.remove('hidden');
          toggle.setAttribute('aria-label', 'Close rule navigation');
          toggle.setAttribute('aria-expanded', 'true');
          document.body.style.overflow = 'hidden';
          // Move focus into sidebar
          const firstLink = sidebar.querySelector('a, button, [tabindex="0"]');
          if (firstLink) firstLink.focus();
        }

        function closeSidebar() {
          sidebar.classList.add('-translate-x-full');
          overlay.classList.add('hidden');
          toggle.setAttribute('aria-label', 'Open rule navigation');
          toggle.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = '';
          // Return focus to toggle
          toggle.focus();
        }

        toggle.addEventListener('click', () => {
          toggle.getAttribute('aria-expanded') === 'true' ? closeSidebar() : openSidebar();
        });
        overlay.addEventListener('click', closeSidebar);

        // Auto-close sidebar when a rule link is tapped on mobile
        sidebar.querySelectorAll('a').forEach((link) => {
          link.addEventListener('click', () => {
            if (window.innerWidth < 768) closeSidebar();
          });
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') closeSidebar();

          // Focus trap: when sidebar is open, keep Tab within sidebar elements
          if (e.key === 'Tab' && toggle.getAttribute('aria-expanded') === 'true') {
            const focusable = Array.from(
              sidebar.querySelectorAll('a, button, [tabindex="0"], [tabindex="-1"]:not([tabindex="-1"])')
            ).filter((el) => !el.hasAttribute('disabled') && el.offsetParent !== null);
            if (focusable.length === 0) return;
            const first = focusable[0];
            const last = focusable[focusable.length - 1];
            if (e.shiftKey) {
              if (document.activeElement === first) {
                e.preventDefault();
                last.focus();
              }
            } else {
              if (document.activeElement === last) {
                e.preventDefault();
                first.focus();
              }
            }
          }
        });
      </script>
    )}
  </body>
</html>
