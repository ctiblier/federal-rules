---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const civilEntries = await getCollection('civil');
const criminalEntries = await getCollection('criminal');
const appellateEntries = await getCollection('appellate');
const evidenceEntries = await getCollection('evidence');
const bankruptcyEntries = await getCollection('bankruptcy');

const civilCurrent = civilEntries.filter(e => e.id.endsWith('/current.md'));
const criminalCurrent = criminalEntries.filter(e => e.id.endsWith('/current.md'));
const appellateCurrent = appellateEntries.filter(e => e.id.endsWith('/current.md'));
const evidenceCurrent = evidenceEntries.filter(e => e.id.endsWith('/current.md'));
const bankruptcyCurrent = bankruptcyEntries.filter(e => e.id.endsWith('/current.md'));

// Get last amended date from any current entry
const civilLastAmended = civilCurrent[0]?.data.last_amended ?? '';
const criminalLastAmended = criminalCurrent[0]?.data.last_amended ?? '';
const appellateLastAmended = appellateCurrent[0]?.data.last_amended ?? '';
const evidenceLastAmended = evidenceCurrent[0]?.data.last_amended ?? '';
const bankruptcyLastAmended = bankruptcyCurrent[0]?.data.last_amended ?? '';
---

<BaseLayout
  title="Home"
  description="Federal Rules of Civil, Criminal, Appellate, Evidence, and Bankruptcy Procedure — professional reference for attorneys and law students."
  noSidebar={true}
>
  <div style="max-width: 680px; margin: 0 auto; padding: 5rem 1.5rem 6rem;">
    <!-- Hero -->
    <header style="margin-bottom: 3.5rem;">
      <h1 style="font-family: 'Lora', Georgia, serif; font-size: clamp(1.75rem, 4vw, 2.5rem); font-weight: 700; color: #1c1c1e; line-height: 1.2; margin-bottom: 1rem;">
        Federal Rules, finally readable.
      </h1>
      <p style="font-family: 'Lora', Georgia, serif; font-size: 1.0625rem; color: #6b7280; line-height: 1.7; max-width: 520px;">
        The complete Federal Rules of Procedure — with search, version history, and one-click citation.
      </p>
    </header>

    <!-- Search -->
    <section id="search" aria-label="Search all rules" style="margin-bottom: 3.5rem;">
      <h2 style="font-family: system-ui, sans-serif; font-size: 0.6875rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: #6b7280; margin-bottom: 0.875rem;">
        Search
      </h2>
      <!-- Ruleset pills -->
      <div id="ruleset-pills" role="group" aria-label="Filter by ruleset" style="display: flex; flex-wrap: wrap; gap: 0.375rem; margin-bottom: 0.875rem;">
        <button class="rs-pill rs-pill--active" data-ruleset="" aria-pressed="true">All</button>
        <button class="rs-pill" data-ruleset="civil" aria-pressed="false">Civil</button>
        <button class="rs-pill" data-ruleset="criminal" aria-pressed="false">Criminal</button>
        <button class="rs-pill" data-ruleset="appellate" aria-pressed="false">Appellate</button>
        <button class="rs-pill" data-ruleset="evidence" aria-pressed="false">Evidence</button>
        <button class="rs-pill" data-ruleset="bankruptcy" aria-pressed="false">Bankruptcy</button>
      </div>
      <div id="home-search">
        <div style="position: relative;">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"
            style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #9ca3af; pointer-events: none;">
            <circle cx="6.5" cy="6.5" r="4.5" stroke="currentColor" stroke-width="1.4"/>
            <path d="M10.5 10.5l3.5 3.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
          </svg>
          <input
            type="search"
            id="hs-input"
            placeholder="Search rules…"
            autocomplete="off"
            aria-label="Search federal rules"
            style="width: 100%; padding: 0.6rem 1rem 0.6rem 2.5rem; border: 1px solid rgba(28,28,30,0.2); border-radius: 0.375rem; font-family: system-ui, sans-serif; font-size: 0.9375rem; color: #1c1c1e; background: white; box-sizing: border-box; -webkit-appearance: none; appearance: none;"
          />
        </div>
        <div id="hs-results" role="region" aria-label="Search results" aria-live="polite" style="margin-top: 0.5rem;"></div>
      </div>
    </section>

    <!-- Ruleset cards -->
    <section aria-label="Available rulesets" style="margin-bottom: 4rem;">
      <h2 style="font-family: system-ui, sans-serif; font-size: 0.6875rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: #6b7280; margin-bottom: 0.875rem;">
        Rulesets
      </h2>
      <div style="display: flex; flex-direction: column; gap: 0.75rem;">

        <!-- Civil Procedure -->
        <a
          href="/civil/"
          class="ruleset-card"
          style="display: block; padding: 1.25rem 1.5rem; border-radius: 0.5rem; border: 1px solid rgba(28,28,30,0.15); background-color: white; text-decoration: none; transition: border-color 0.15s, box-shadow 0.15s;"
        >
          <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 1rem;">
            <div>
              <p style="font-family: system-ui, sans-serif; font-size: 0.6875rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: #1a2744; margin-bottom: 0.375rem;">
                Civil Procedure
              </p>
              <p style="font-family: 'Lora', Georgia, serif; font-size: 1rem; font-weight: 700; color: #1c1c1e; margin-bottom: 0.375rem; line-height: 1.3;">
                Federal Rules of Civil Procedure
              </p>
              <p style="font-family: system-ui, sans-serif; font-size: 0.8125rem; color: #6b7280;">
                Last amended {civilLastAmended}
              </p>
            </div>
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" aria-hidden="true" style="color: #1a2744; flex-shrink: 0; margin-top: 0.25rem;">
              <path d="M3 9h12M10 4l5 5-5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </a>

        <!-- Criminal Procedure -->
        <a
          href="/criminal/"
          class="ruleset-card"
          style="display: block; padding: 1.25rem 1.5rem; border-radius: 0.5rem; border: 1px solid rgba(28,28,30,0.15); background-color: white; text-decoration: none; transition: border-color 0.15s, box-shadow 0.15s;"
        >
          <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 1rem;">
            <div>
              <p style="font-family: system-ui, sans-serif; font-size: 0.6875rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: #1a2744; margin-bottom: 0.375rem;">
                Criminal Procedure
              </p>
              <p style="font-family: 'Lora', Georgia, serif; font-size: 1rem; font-weight: 700; color: #1c1c1e; margin-bottom: 0.375rem; line-height: 1.3;">
                Federal Rules of Criminal Procedure
              </p>
              <p style="font-family: system-ui, sans-serif; font-size: 0.8125rem; color: #6b7280;">
                Last amended {criminalLastAmended}
              </p>
            </div>
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" aria-hidden="true" style="color: #1a2744; flex-shrink: 0; margin-top: 0.25rem;">
              <path d="M3 9h12M10 4l5 5-5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </a>

        <!-- Appellate Procedure -->
        <a
          href="/appellate/"
          class="ruleset-card"
          style="display: block; padding: 1.25rem 1.5rem; border-radius: 0.5rem; border: 1px solid rgba(28,28,30,0.15); background-color: white; text-decoration: none; transition: border-color 0.15s, box-shadow 0.15s;"
        >
          <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 1rem;">
            <div>
              <p style="font-family: system-ui, sans-serif; font-size: 0.6875rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: #1a2744; margin-bottom: 0.375rem;">
                Appellate Procedure
              </p>
              <p style="font-family: 'Lora', Georgia, serif; font-size: 1rem; font-weight: 700; color: #1c1c1e; margin-bottom: 0.375rem; line-height: 1.3;">
                Federal Rules of Appellate Procedure
              </p>
              <p style="font-family: system-ui, sans-serif; font-size: 0.8125rem; color: #6b7280;">
                Last amended {appellateLastAmended}
              </p>
            </div>
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" aria-hidden="true" style="color: #1a2744; flex-shrink: 0; margin-top: 0.25rem;">
              <path d="M3 9h12M10 4l5 5-5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </a>

        <!-- Evidence -->
        <a
          href="/evidence/"
          class="ruleset-card"
          style="display: block; padding: 1.25rem 1.5rem; border-radius: 0.5rem; border: 1px solid rgba(28,28,30,0.15); background-color: white; text-decoration: none; transition: border-color 0.15s, box-shadow 0.15s;"
        >
          <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 1rem;">
            <div>
              <p style="font-family: system-ui, sans-serif; font-size: 0.6875rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: #1a2744; margin-bottom: 0.375rem;">
                Evidence
              </p>
              <p style="font-family: 'Lora', Georgia, serif; font-size: 1rem; font-weight: 700; color: #1c1c1e; margin-bottom: 0.375rem; line-height: 1.3;">
                Federal Rules of Evidence
              </p>
              <p style="font-family: system-ui, sans-serif; font-size: 0.8125rem; color: #6b7280;">
                Last amended {evidenceLastAmended}
              </p>
            </div>
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" aria-hidden="true" style="color: #1a2744; flex-shrink: 0; margin-top: 0.25rem;">
              <path d="M3 9h12M10 4l5 5-5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </a>

        <!-- Bankruptcy Procedure -->
        <a
          href="/bankruptcy/"
          class="ruleset-card"
          style="display: block; padding: 1.25rem 1.5rem; border-radius: 0.5rem; border: 1px solid rgba(28,28,30,0.15); background-color: white; text-decoration: none; transition: border-color 0.15s, box-shadow 0.15s;"
        >
          <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 1rem;">
            <div>
              <p style="font-family: system-ui, sans-serif; font-size: 0.6875rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: #1a2744; margin-bottom: 0.375rem;">
                Bankruptcy Procedure
              </p>
              <p style="font-family: 'Lora', Georgia, serif; font-size: 1rem; font-weight: 700; color: #1c1c1e; margin-bottom: 0.375rem; line-height: 1.3;">
                Federal Rules of Bankruptcy Procedure
              </p>
              <p style="font-family: system-ui, sans-serif; font-size: 0.8125rem; color: #6b7280;">
                Last amended {bankruptcyLastAmended}
              </p>
            </div>
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" aria-hidden="true" style="color: #1a2744; flex-shrink: 0; margin-top: 0.25rem;">
              <path d="M3 9h12M10 4l5 5-5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </a>

      </div>
    </section>
  </div>

  <!-- Footer -->
  <footer style="border-top: 1px solid rgba(28,28,30,0.1); padding: 1.5rem; text-align: center;">
    <nav aria-label="Footer" style="font-family: system-ui, sans-serif; font-size: 0.8125rem; color: #9ca3af; display: flex; justify-content: center; gap: 1.5rem;">
      <a href="/about/" style="color: #9ca3af; text-decoration: none; transition: color 0.15s;" onmouseover="this.style.color='#374151'" onmouseout="this.style.color='#9ca3af'">About</a>
      <a href="/privacy/" style="color: #9ca3af; text-decoration: none; transition: color 0.15s;" onmouseover="this.style.color='#374151'" onmouseout="this.style.color='#9ca3af'">Privacy</a>
    </nav>
  </footer>
</BaseLayout>

<style>
  .ruleset-card:hover {
    border-color: rgba(28,28,30,0.3);
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  .rs-pill {
    font-family: system-ui, sans-serif;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    border: 1px solid rgba(28,28,30,0.2);
    background: white;
    color: #6b7280;
    cursor: pointer;
    transition: background-color 0.12s, color 0.12s, border-color 0.12s;
    line-height: 1.6;
  }
  .rs-pill:hover {
    border-color: #1a2744;
    color: #1a2744;
  }
  .rs-pill--active {
    background-color: #1a2744;
    color: white;
    border-color: #1a2744;
  }
  .rs-pill--active:hover {
    color: white;
  }
</style>

<style is:global>
  .hs-result:hover {
    border-color: rgba(28,28,30,0.28) !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  .hs-result mark {
    background: #fde68a;
    color: #1c1c1e;
    border-radius: 2px;
    padding: 0 1px;
  }
  #hs-input:focus {
    outline: none;
    border-color: #1a2744;
    box-shadow: 0 0 0 3px rgba(26,39,68,0.12);
  }
</style>

<script>
  // ─── State ────────────────────────────────────────────────────────────────
  const selectedRulesets = new Set<string>();
  let pfPromise: Promise<any> | null = null;
  let debounceTimer: ReturnType<typeof setTimeout> | null = null;

  // ─── Helpers ──────────────────────────────────────────────────────────────
  const RULESET_LABELS: Record<string, string> = {
    civil:      'Civil',
    criminal:   'Criminal',
    appellate:  'Appellate',
    evidence:   'Evidence',
    bankruptcy: 'Bankruptcy',
  };

  function esc(s: string): string {
    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function rulesetFromUrl(url: string): string {
    const m = url.match(/^\/(civil|criminal|appellate|evidence|bankruptcy)\//);
    return m ? m[1] : '';
  }

  // ─── Pagefind loader ──────────────────────────────────────────────────────
  function loadPagefind(): Promise<any> {
    if (!pfPromise) {
      pfPromise = (import(/* @vite-ignore */ '/pagefind/pagefind.js') as Promise<any>).catch(() => null);
    }
    return pfPromise!;
  }

  // Eagerly start loading in the background so it's ready when the user types
  loadPagefind();

  // ─── Search ───────────────────────────────────────────────────────────────
  async function runSearch(query: string) {
    const resultsEl = document.getElementById('hs-results');
    if (!resultsEl) return;

    query = query.trim();
    if (!query) {
      resultsEl.innerHTML = '';
      return;
    }

    const pf = await loadPagefind();
    if (!pf) {
      resultsEl.innerHTML =
        '<p style="font-family:system-ui,sans-serif;font-size:0.875rem;color:#6b7280;padding:0.75rem 0;">' +
        'Search is available after running <code>npm run build</code>.</p>';
      return;
    }

    const filters = selectedRulesets.size > 0 ? { ruleset: [...selectedRulesets] } : {};
    const search = await pf.search(query, { filters });

    if (!search || !search.results.length) {
      resultsEl.innerHTML =
        `<p style="font-family:system-ui,sans-serif;font-size:0.875rem;color:#6b7280;padding:0.75rem 0;">` +
        `No results for "<strong>${esc(query)}</strong>".</p>`;
      return;
    }

    const items = await Promise.all(search.results.slice(0, 8).map((r: any) => r.data()));

    resultsEl.innerHTML = items.map((item: any) => {
      const rs = rulesetFromUrl(item.url);
      const label = RULESET_LABELS[rs] ?? '';
      const title = esc((item.meta?.title ?? '').replace(/\s*\|\s*Federal Rules.*$/, ''));
      const excerpt: string = item.excerpt ?? '';  // contains <mark> — our own build content
      const url = esc(item.url);
      return (
        `<a href="${url}" class="hs-result" style="display:block;padding:0.75rem 1rem;border-radius:0.375rem;border:1px solid rgba(28,28,30,0.12);background:white;text-decoration:none;margin-top:0.5rem;">` +
        `<div style="display:flex;align-items:baseline;gap:0.5rem;margin-bottom:0.2rem;">` +
        (label ? `<span style="font-family:system-ui,sans-serif;font-size:0.6875rem;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;color:#1a2744;flex-shrink:0;">${label}</span>` : '') +
        `<span style="font-family:'Lora',Georgia,serif;font-size:0.9375rem;font-weight:700;color:#1c1c1e;">${title}</span>` +
        `</div>` +
        `<p style="font-family:system-ui,sans-serif;font-size:0.8125rem;color:#6b7280;margin:0;line-height:1.5;">${excerpt}</p>` +
        `</a>`
      );
    }).join('');
  }

  // ─── Input handler ────────────────────────────────────────────────────────
  const hsInput = document.getElementById('hs-input') as HTMLInputElement | null;
  if (hsInput) {
    hsInput.addEventListener('input', () => {
      if (debounceTimer !== null) clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => runSearch(hsInput.value), 250);
    });
  }

  // ─── Pills ────────────────────────────────────────────────────────────────
  function syncPills() {
    const anySelected = selectedRulesets.size > 0;
    document.querySelectorAll<HTMLButtonElement>('.rs-pill').forEach((b) => {
      const r = b.dataset.ruleset ?? '';
      const active = r === '' ? !anySelected : selectedRulesets.has(r);
      b.classList.toggle('rs-pill--active', active);
      b.setAttribute('aria-pressed', active ? 'true' : 'false');
    });
  }

  document.querySelectorAll<HTMLButtonElement>('.rs-pill').forEach((btn) => {
    btn.addEventListener('click', () => {
      const r = btn.dataset.ruleset ?? '';
      if (r === '') {
        selectedRulesets.clear();
      } else {
        if (selectedRulesets.has(r)) selectedRulesets.delete(r);
        else selectedRulesets.add(r);
      }
      syncPills();
      if (hsInput?.value.trim()) runSearch(hsInput.value);
    });
  });
</script>
