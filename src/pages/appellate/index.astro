---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const allEntries = await getCollection('appellate');
const rules = allEntries.filter((e) => e.id.endsWith('/current.md'));

const sorted = rules.sort((a, b) => {
  return parseFloat(a.data.rule) - parseFloat(b.data.rule);
});

type GroupValue = { title_number: string; title_name: string; rules: typeof sorted };
const groups = new Map<string, GroupValue>();
for (const rule of sorted) {
  const key = `${rule.data.title_number}||${rule.data.title_name}`;
  if (!groups.has(key)) {
    groups.set(key, { title_number: rule.data.title_number, title_name: rule.data.title_name, rules: [] });
  }
  groups.get(key)!.rules.push(rule);
}

const total = rules.length;
---

<BaseLayout
  title="Federal Rules of Appellate Procedure"
  description="Complete index of all Federal Rules of Appellate Procedure, grouped by title."
  ruleset="appellate"
>
  <div class="max-w-3xl mx-auto px-6 py-12">
    <header style="margin-bottom: 2.5rem;">
      <h1 style="font-family: 'Lora', Georgia, serif; font-size: 1.5rem; font-weight: 700; color: #1c1c1e; margin-bottom: 0.5rem;">
        Federal Rules of Appellate Procedure
      </h1>
      <p style="font-size: 0.875rem; color: #6b7280; font-family: system-ui, sans-serif;">
        {total} rules &middot; Current through December 1, 2024
      </p>
    </header>

    <!-- Pagefind search — sticky on scroll -->
    <div class="search-sticky" style="position: sticky; top: 3.25rem; z-index: 10; background-color: #f8f5f0; padding-bottom: 1rem; margin-bottom: 1rem;">
      <section id="search" aria-label="Search appellate rules">
        <div id="pagefind-search"></div>
      </section>
    </div>

    {Array.from(groups.values()).map((group) => (
      <section style="margin-bottom: 2.5rem;">
        <h2 style="font-size: 0.6875rem; font-family: system-ui, sans-serif; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: #6b7280; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(28,28,30,0.1);">
          {group.title_number ? `Title ${group.title_number} · ` : ''}{group.title_name}
        </h2>
        <ul>
          {group.rules.map((rule) => (
            <li>
              <a
                href={`/appellate/${rule.data.rule}/`}
                class="rule-index-link"
                style="display: flex; align-items: baseline; gap: 0.75rem; padding: 0.5rem 0.75rem; margin: 0 -0.75rem; border-radius: 0.375rem; text-decoration: none; transition: background-color 0.1s;"
              >
                <span style="font-family: 'Courier New', monospace; font-size: 0.75rem; font-weight: 700; color: #1a2744; width: 1.75rem; flex-shrink: 0; text-align: right;">
                  {rule.data.rule}
                </span>
                <span style="font-family: 'Lora', Georgia, serif; font-size: 0.9375rem; color: #1c1c1e; flex: 1;">
                  {rule.data.title}
                </span>
              </a>
            </li>
          ))}
        </ul>
      </section>
    ))}
  </div>
</BaseLayout>

<style>
  .rule-index-link:hover { background-color: rgba(28,28,30,0.04); }
</style>

<script>
  const searchEl = document.getElementById('pagefind-search');
  if (searchEl) {
    const script = document.createElement('script');
    script.src = '/pagefind/pagefind-ui.js';
    script.onload = () => {
      new (window as any).PagefindUI({
        element: '#pagefind-search',
        showSubResults: true,
        resetStyles: false,
        filters: { ruleset: 'appellate' },
      });
    };
    script.onerror = () => {
      if (searchEl) {
        searchEl.innerHTML = '<p style="color: #6b7280; font-size: 0.875rem; font-family: system-ui, sans-serif;">Search available after running <code>npm run build</code>.</p>';
      }
    };
    document.head.appendChild(script);
  }
</script>
