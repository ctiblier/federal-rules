---
import BaseLayout from '../../layouts/BaseLayout.astro';
import RuleTOC from '../../components/RuleTOC.astro';
import CopyCitation from '../../components/CopyCitation.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const rules = await getCollection('rules');
  return rules.map((entry) => ({
    params: { rule: entry.data.rule },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

// Detect abrogated rules: body has no substantive content beyond the heading
const bodyText = entry.body?.replace(/^##[^\n]*\n?/, '').trim() ?? '';
const isAbrogated = bodyText.length < 30;
---

<BaseLayout
  title={`Rule ${entry.data.rule}. ${entry.data.title}`}
  description={`Rule ${entry.data.rule} of the Federal Rules of Civil Procedure: ${entry.data.title}. Current through ${entry.data.last_amended}.`}
>
  <div class="flex gap-10 px-6 py-10 max-w-5xl mx-auto">
    <!-- Main rule content -->
    <article class="flex-1 min-w-0" data-pagefind-body>
      <header class="mb-8 pb-6" style="border-bottom: 1px solid rgba(28,28,30,0.1);">
        <p class="text-xs uppercase tracking-wider mb-2" style="color: #6b7280; font-family: system-ui, sans-serif;">
          Title {entry.data.title_number} &middot; {entry.data.title_name}
        </p>
        <h1
          class="text-2xl font-bold mb-4 leading-snug"
          style="font-family: 'Lora', Georgia, serif; color: #1c1c1e;"
          data-pagefind-meta="title"
        >
          Rule {entry.data.rule}. {entry.data.title}
        </h1>
        <div class="flex flex-wrap items-center gap-4 text-sm" style="color: #6b7280; font-family: system-ui, sans-serif;">
          <span>Amended {entry.data.last_amended}</span>
          {entry.data.has_deadlines && (
            <span
              class="text-[11px] font-semibold uppercase tracking-wide rounded px-2 py-0.5"
              style="color: #92400e; background-color: #fffbeb; border: 1px solid #fde68a;"
            >
              Contains Deadlines
            </span>
          )}
          <CopyCitation ruleNumber={entry.data.rule} />
        </div>
      </header>

      {isAbrogated ? (
        <div class="rounded-lg px-6 py-5" style="border: 1px solid rgba(28,28,30,0.1); background-color: rgba(28,28,30,0.04);">
          <p class="font-semibold mb-1" style="font-family: system-ui, sans-serif; color: #1c1c1e;">
            Rule {entry.data.rule} has been abrogated.
          </p>
          <p class="text-sm" style="color: #6b7280; font-family: system-ui, sans-serif;">
            This rule was removed from the Federal Rules of Civil Procedure and is no longer in effect.
          </p>
        </div>
      ) : (
        <div class="rule-body">
          <Content />
        </div>
      )}

      <footer class="mt-12 pt-6 text-xs" style="border-top: 1px solid rgba(28,28,30,0.1); color: #6b7280; font-family: system-ui, sans-serif;">
        Source:&nbsp;
        <a
          href={entry.data.source_pdf_url}
          class="underline underline-offset-2 transition-colors"
          style="color: #6b7280;"
          target="_blank"
          rel="noopener noreferrer"
        >
          Official FRCP PDF
        </a>
        , p.&nbsp;{entry.data.source_pdf_page}.
      </footer>
    </article>

    <!-- Right TOC sidebar (only for non-abrogated rules) -->
    {!isAbrogated && <RuleTOC />}
  </div>
</BaseLayout>
