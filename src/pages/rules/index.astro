---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const rules = await getCollection('rules');

const sorted = rules.sort((a, b) => {
  const aIsLetter = /^[A-G]$/.test(a.data.rule);
  const bIsLetter = /^[A-G]$/.test(b.data.rule);
  if (aIsLetter && !bIsLetter) return 1;
  if (!aIsLetter && bIsLetter) return -1;
  if (aIsLetter && bIsLetter) return a.data.rule.localeCompare(b.data.rule);
  return parseFloat(a.data.rule) - parseFloat(b.data.rule);
});

type GroupValue = { title_name: string; rules: typeof sorted };
const groups = new Map<string, GroupValue>();
for (const rule of sorted) {
  const key = `${rule.data.title_number}||${rule.data.title_name}`;
  if (!groups.has(key)) {
    groups.set(key, { title_name: rule.data.title_name, rules: [] });
  }
  groups.get(key)!.rules.push(rule);
}

const total = rules.length;
---

<BaseLayout
  title="All Rules"
  description="Complete index of all 104 Federal Rules of Civil Procedure, grouped by title."
>
  <div class="max-w-3xl mx-auto px-6 py-12">
    <header style="margin-bottom: 2.5rem;">
      <h1 style="font-family: 'Lora', Georgia, serif; font-size: 1.5rem; font-weight: 700; color: #1c1c1e; margin-bottom: 0.5rem;">
        Federal Rules of Civil Procedure
      </h1>
      <p style="font-size: 0.875rem; color: #6b7280; font-family: system-ui, sans-serif;">
        {total} rules &middot; Current through December 1, 2024
      </p>
    </header>

    {Array.from(groups.values()).map((group) => (
      <section style="margin-bottom: 2.5rem;">
        <h2 style="font-size: 0.6875rem; font-family: system-ui, sans-serif; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: #6b7280; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(28,28,30,0.1);">
          {group.title_name}
        </h2>
        <ul>
          {group.rules.map((rule) => (
            <li>
              <a
                href={`/rules/${rule.data.rule}/`}
                style="display: flex; align-items: baseline; gap: 0.75rem; padding: 0.5rem 0.75rem; margin: 0 -0.75rem; border-radius: 0.375rem; text-decoration: none; transition: background-color 0.1s;"
                onmouseover="this.style.backgroundColor='rgba(28,28,30,0.04)'"
                onmouseout="this.style.backgroundColor=''"
              >
                <span style="font-family: 'Courier New', monospace; font-size: 0.75rem; color: #6b7280; width: 1.75rem; flex-shrink: 0; text-align: right;">
                  {rule.data.rule}
                </span>
                <span style="font-family: 'Lora', Georgia, serif; font-size: 0.9375rem; color: #1c1c1e; flex: 1;">
                  {rule.data.title}
                </span>
                {rule.data.has_deadlines && (
                  <span style="flex-shrink: 0; font-size: 0.625rem; font-family: system-ui, sans-serif; font-weight: 700; letter-spacing: 0.05em; text-transform: uppercase; color: #92400e; background-color: #fffbeb; border: 1px solid #fde68a; border-radius: 0.25rem; padding: 0.125rem 0.375rem;">
                    Deadlines
                  </span>
                )}
              </a>
            </li>
          ))}
        </ul>
      </section>
    ))}
  </div>
</BaseLayout>
