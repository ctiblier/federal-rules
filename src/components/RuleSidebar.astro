---
import { getCollection } from 'astro:content';
import { computeHasDeadlines } from '../utils/hasDeadlines';

interface Props {
  ruleset: 'civil' | 'criminal' | 'appellate' | 'evidence' | 'bankruptcy';
}
const { ruleset } = Astro.props;
const basePath = `/${ruleset}`;

const RULESET_LABELS: Record<string, { short: string; full: string }> = {
  civil:      { short: 'FRCP',  full: 'Federal Rules of Civil Procedure' },
  criminal:   { short: 'FRCrP', full: 'Federal Rules of Criminal Procedure' },
  appellate:  { short: 'FRAP',  full: 'Federal Rules of Appellate Procedure' },
  evidence:   { short: 'FRE',   full: 'Federal Rules of Evidence' },
  bankruptcy: { short: 'FRBP',  full: 'Federal Rules of Bankruptcy Procedure' },
};
const label = RULESET_LABELS[ruleset]?.full ?? 'Federal Rules';
const allEntries = await getCollection(ruleset);
const rules = allEntries.filter((e) => e.id.endsWith('/current.md'));

const sorted = rules.sort((a, b) => {
  const aIsLetter = /^[A-G]$/.test(a.data.rule);
  const bIsLetter = /^[A-G]$/.test(b.data.rule);
  if (aIsLetter && !bIsLetter) return 1;
  if (!aIsLetter && bIsLetter) return -1;
  if (aIsLetter && bIsLetter) return a.data.rule.localeCompare(b.data.rule);
  return parseFloat(a.data.rule) - parseFloat(b.data.rule);
});

// Group prefix varies by ruleset: evidence uses "Article", bankruptcy uses "Part", others use "Title"
const groupPrefix = ruleset === 'evidence' ? 'Article' : ruleset === 'bankruptcy' ? 'Part' : 'Title';

type GroupValue = { title_number: string; title_name: string; rules: typeof sorted };
const groups = new Map<string, GroupValue>();
for (const rule of sorted) {
  const key = rule.data.title_number;
  if (!groups.has(key)) {
    groups.set(key, { title_number: rule.data.title_number, title_name: rule.data.title_name, rules: [] });
  }
  groups.get(key)!.rules.push(rule);
}

const currentPath = Astro.url.pathname;
---

<nav class="py-2" aria-label={label}>
  <div class="px-4 py-3 pt-14 md:pt-3 pb-3 border-b" style="border-color: rgba(255,255,255,0.1);">
    <a href="/" class="text-[10px] font-semibold uppercase tracking-widest transition-opacity opacity-95 hover:opacity-100" style="color: #c9a84c; font-family: system-ui, sans-serif;">
      ‚Üê All Rulesets
    </a>
    <a href={basePath} class="mt-1 text-[12px] font-bold leading-tight block transition-opacity hover:opacity-95" style="color: white; font-family: system-ui, sans-serif; text-decoration: none;">
      {label}
    </a>
  </div>

  {Array.from(groups.entries()).map(([titleNum, group]) => {
    const isSupplemental = titleNum === '';
    const groupLabel = isSupplemental ? 'Supplemental Rules' : `${groupPrefix} ${titleNum}`;

    return (
      <details open>
        <summary
          class="flex items-center justify-between px-4 py-2 cursor-pointer select-none text-[11px] font-bold tracking-widest uppercase list-none"
          style="color: rgba(255,255,255,0.7); font-family: system-ui, sans-serif;"
        >
          {groupLabel}
          <svg class="w-3 h-3" viewBox="0 0 10 10" fill="none" aria-hidden="true">
            <path d="M3 2l4 3-4 3" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </summary>
        <ul>
          {group.rules.map((rule) => {
            const href = `${basePath}/${rule.data.rule}/`;
            const isActive = currentPath === href || currentPath === `${basePath}/${rule.data.rule}`;
            return (
              <li>
                <a
                  href={href}
                  class="flex items-baseline gap-2 px-4 py-1.5 text-[13px] transition-colors"
                  style={isActive
                    ? 'background-color: rgba(201,168,76,0.2); color: #c9a84c; font-weight: 600; font-family: system-ui, sans-serif;'
                    : 'color: rgba(255,255,255,0.9); font-family: system-ui, sans-serif;'
                  }
                  aria-current={isActive ? 'page' : undefined}
                >
                  <span class="font-mono text-[12px] w-12 shrink-0 text-right" style="color: rgba(255,255,255,0.8);">
                    {rule.data.rule}
                  </span>
                  <span class="truncate flex-1">{rule.data.title}</span>
                  {computeHasDeadlines(rule) && (
                    <span class="shrink-0 text-[9px] font-bold uppercase tracking-wide px-1 rounded" style="background: rgba(201,168,76,0.2); color: #c9a84c; line-height: 1.6;">
                      D
                    </span>
                  )}
                </a>
              </li>
            );
          })}
        </ul>
      </details>
    );
  })}
</nav>

<script>
  const active = document.querySelector('#rule-sidebar a[aria-current="page"]');
  if (active) active.scrollIntoView({ block: 'center' });
</script>
