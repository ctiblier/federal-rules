---
import { getCollection } from 'astro:content';

const allEntries = await getCollection('rules');
const rules = allEntries.filter((e) => e.id.endsWith('/current.md'));

// Sort: numeric rules by float value, supplemental letters (A-G) go last
const sorted = rules.sort((a, b) => {
  const aIsLetter = /^[A-G]$/.test(a.data.rule);
  const bIsLetter = /^[A-G]$/.test(b.data.rule);
  if (aIsLetter && !bIsLetter) return 1;
  if (!aIsLetter && bIsLetter) return -1;
  if (aIsLetter && bIsLetter) return a.data.rule.localeCompare(b.data.rule);
  return parseFloat(a.data.rule) - parseFloat(b.data.rule);
});

// Group by title_number
type GroupValue = { title_name: string; rules: typeof sorted };
const groups = new Map<string, GroupValue>();
for (const rule of sorted) {
  const key = rule.data.title_number;
  if (!groups.has(key)) {
    groups.set(key, { title_name: rule.data.title_name, rules: [] });
  }
  groups.get(key)!.rules.push(rule);
}

const currentPath = Astro.url.pathname;
---

<nav class="py-2" aria-label="All FRCP rules">
  <a
    href="/"
    class="flex items-center gap-2 px-4 py-3 text-sm font-bold border-b"
    style="color: #c9a84c; border-color: rgba(255,255,255,0.1); font-family: system-ui, sans-serif;"
  >
    Federal Rules
  </a>

  {Array.from(groups.entries()).map(([titleNum, group]) => {
    const isSupplemental = titleNum === '';
    const groupLabel = isSupplemental ? 'Supplemental Rules' : `Title ${titleNum}`;

    return (
      <details open>
        <summary
          class="flex items-center justify-between px-4 py-2 cursor-pointer select-none text-[11px] font-bold tracking-widest uppercase list-none"
          style="color: rgba(255,255,255,0.5); font-family: system-ui, sans-serif;"
        >
          {groupLabel}
          <svg class="w-3 h-3" viewBox="0 0 10 10" fill="none" aria-hidden="true">
            <path d="M3 2l4 3-4 3" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </summary>
        <ul>
          {group.rules.map((rule) => {
            const href = `/rules/${rule.data.rule}/`;
            const isActive = currentPath === href || currentPath === `/rules/${rule.data.rule}`;
            return (
              <li>
                <a
                  href={href}
                  class="flex items-baseline gap-2 px-4 py-1.5 text-[13px] transition-colors"
                  style={isActive
                    ? 'background-color: rgba(201,168,76,0.2); color: #c9a84c; font-weight: 600; font-family: system-ui, sans-serif;'
                    : 'color: rgba(255,255,255,0.75); font-family: system-ui, sans-serif;'
                  }
                  aria-current={isActive ? 'page' : undefined}
                >
                  <span class="font-mono text-[12px] w-8 shrink-0 text-right" style="color: rgba(255,255,255,0.6);">
                    {rule.data.rule}
                  </span>
                  <span class="truncate">{rule.data.title}</span>
                </a>
              </li>
            );
          })}
        </ul>
      </details>
    );
  })}
</nav>

<script>
  const active = document.querySelector('#rule-sidebar a[aria-current="page"]');
  if (active) active.scrollIntoView({ block: 'center' });
</script>
